(()=>{"use strict";(()=>{function e(e,t){let s=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0);e.notes?s.querySelector("#notes").innerHTML=e.notes:s.querySelector("#notes-box").style.display="none";let i=s.querySelector("#end-turn");i.onclick=e=>{t({type:"end-turn"})};let n=s.querySelector("#update-turn"),a=s.querySelector("#play");s.querySelector("#pause").style.display=e.isPaused?"none":"shown",a.style.display=e.isPaused?"shown":"none",n.onclick=s=>{t({type:"update-turn",payload:!e.isPaused})};let r=s.querySelector("#timer");null!=e.timePassed&&(r.innerHTML=function(e){let t=Math.floor(e%36e5/6e4);var s=Math.floor(e%6e4/1e3);return(t<10?"0"+t:t)+":"+(s<10?"0"+s:s)}(e.timePassed));let l=e.members.find((t=>0==t.tookTurn&&t.clientInfo.clientUuid!=e.currentSpeaker.clientInfo.clientUuid));if(null!=e.currentSpeaker){let t=s.querySelector("#speaker");e.currentSpeaker.clientInfo.clientUuid==e.currentClient.clientUuid?t.innerHTML='Its <span class="highlight">your</span> turn now!':(n.style.display="none",i.style.display="none",t.innerHTML=null!=l?`<span class="highlight">${e.currentSpeaker.clientInfo.clientName}</span> is taking a turn`:`<span class="highlight">${e.currentSpeaker.clientInfo.clientName}</span> is taking the <span class="highlight">last</span> turn`)}return null!=l&&(s.querySelector("#next-speaker").innerHTML=l.clientInfo.clientUuid==e.currentClient.clientUuid?"You are next":`${l.clientInfo.clientName} is next`),s}function t(e,t){let s=document.querySelector("#setup").content.cloneNode(!0),i=s.querySelector("textarea"),n=s.querySelector("#launch-application");return document.querySelector("#viewing").hidden=!0,n.onclick=e=>{var s;t({type:"start-application",payload:null!==(s=i.value)&&void 0!==s?s:""})},s}function s(e,t){let s=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0);return s.querySelector("label").innerHTML=`${e.initializer.clientName} is setting up the app`,s}function i(e,t){let s=document.querySelector("#ended").content.cloneNode(!0),i=s.querySelector("#restart-application"),n=s.querySelector("#close-application");return document.querySelector("#viewing").hidden=!0,e.currentClient.clientUuid!=e.initializer.clientUuid&&(i.style.display="none",n.style.display="none"),i.onclick=e=>{t({type:"restart-round"})},n.onclick=e=>{t({type:"close-application"})},s}class n{constructor(e){this.kosyClient=window.parent,this.latestMessageNumber=0,this.kosyApp=e}dictionaryToArray(e){let t=[];for(const s in e)e.hasOwnProperty(s)&&t.push([s,e[s]]);return t}startApp(){return this.initialInfoPromise=new Promise(((e,t)=>{window.addEventListener("message",(t=>{let s=t.data;switch(s.type){case"receive-initial-info":this.latestMessageNumber=s.latestMessageNumber,this.clients=s.payload.clients,this.hostClientUuid=s.payload.initializerClientUuid,this.log("Resolving initial info promise with: ",s.payload),e(s.payload);break;case"set-client-info":{let e=s.clients,t=s.hostClientUuid;this.initialInfoPromise.then((s=>{let i=this.dictionaryToArray(e).filter((e=>!this.clients[e[0]])),n=this.dictionaryToArray(this.clients).filter((t=>!e[t[0]])),a=this.latestMessageNumber;this.hostClientUuid!==t&&this._relayMessageToClients(s,{type:"_host-has-changed",clientUuid:t},++a),i.forEach((e=>this._relayMessageToClients(s,{type:"_client-has-joined",clientInfo:e[1]},++a))),n.forEach((e=>this._relayMessageToClients(s,{type:"_client-has-left",clientUuid:e[0]},++a))),this.clients=e,this.hostClientUuid=t}));break}case"get-app-state":{let e=s.clientUuids;this.log("Get app state received -> sending app state");const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",state:t,clientUuids:e,latestMessageNumber:this.latestMessageNumber});break}case"set-app-state":this.latestMessageNumber=s.latestMessageNumber;let t=s.state;this.initialInfoPromise.then((()=>{this.log("Received app state from Kosy -> setting app state"),this.kosyApp.onProvideState(t)}));break;case"receive-message-as-host":this._handleReceiveMessageAsHost(s);break;case"receive-message-as-client":this._handleReceiveMessageAsClient(s)}})),this._sendMessageToKosy({type:"ready-and-listening"})})),this.initialInfoPromise}stopApp(){this._sendMessageToKosy({type:"stop-app"})}relayMessage(e){this.log("Relaying client message to host: ",e),this._sendMessageToKosy({type:"relay-message-to-host",message:e})}_relayMessageToClients(e,t,s){this.log("Relaying host to client message: ",t),this._sendMessageToKosy({type:"relay-message-to-clients",sentByClientUuid:e.currentClientUuid,message:t,messageNumber:s})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}_handleReceiveMessageAsClientRecursive(e,t,s){var i,n,a,r,l,o;if(this.latestMessageNumber===e.messageNumber-1){switch(e.message.type){case"_host-has-changed":{let t=e.message.clientUuid;this.hostClientUuid=t,null===(n=(i=this.kosyApp).onHostHasChanged)||void 0===n||n.call(i,t);break}case"_client-has-joined":{let t=e.message.clientInfo;this.clients[t.clientUuid]=t,null===(r=(a=this.kosyApp).onClientHasJoined)||void 0===r||r.call(a,t);break}case"_client-has-left":{let t=e.message.clientUuid;this.clients[t]=null,null===(o=(l=this.kosyApp).onClientHasLeft)||void 0===o||o.call(l,t);break}default:this.kosyApp.onReceiveMessageAsClient(e.message)}this.latestMessageNumber=e.messageNumber}else s<50&&this.latestMessageNumber<e.messageNumber?setTimeout((()=>this._handleReceiveMessageAsClientRecursive(e,t,s+1)),100):(this.log("Timeout on processing message as client: ",e.message),this.log("Wait for Kosy to fix this mess..."))}_handleReceiveMessageAsClient(e){this.initialInfoPromise.then((t=>{this.log("Received message as client, processing: ",e.message),this._handleReceiveMessageAsClientRecursive(e,t,0)}))}_handleReceiveMessageAsHost(e){this.initialInfoPromise.then((t=>{this.log("Trying to handle message as host");const s=this.kosyApp.onReceiveMessageAsHost(e.message);s&&this._relayMessageToClients(t,s,this.latestMessageNumber+1)}))}log(...e){"1"===localStorage.getItem("debug-mode")&&console.log("From kosy-app-api: ",...e)}}class a{constructor(e){this.clientInfo=e,this.tookTurn=!1}}var r;!function(r){var l;(function(r){class l{constructor(){this.state={timePassed:0},this.kosyApi=new n({onClientHasJoined:e=>this.onClientHasJoined(e),onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessageAsClient:e=>this.processMessage(e),onReceiveMessageAsHost:e=>this.processMessageAsHost(e),onRequestState:()=>this.getState(),onProvideState:e=>this.setState(e)})}start(){var e,t,s,i,n;return t=this,s=void 0,n=function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,console.log(t),null==this.state.members&&(this.state.members=new Array,t.clients&&Object.keys(t.clients).length>0?Object.keys(t.clients).forEach((e=>this.addMember(t.clients[e]))):this.currentClient.clientUuid==this.initializer.clientUuid&&this.addMember(this.currentClient),this.sortMembers()),this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))},new((i=void 0)||(i=Promise))((function(e,a){function r(e){try{o(n.next(e))}catch(e){a(e)}}function l(e){try{o(n.throw(e))}catch(e){a(e)}}function o(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i((function(e){e(s)}))).then(r,l)}o((n=n.apply(t,s||[])).next())}))}setState(e){this.state=e,this.renderComponent()}getState(){return this.state}onClientHasJoined(e){console.log(`New client (Name: ${e.clientName}) is sitting at: ${e.clientLocation.seatNumber}`),null!=this.currentClient&&null!=this.initializer&&(this.addMember(e),this.sortMembers())}onClientHasLeft(e){console.log("A client has left: "+e),this.removeMember(e),this.sortMembers()}processMessageAsHost(e){switch(console.log("Message received as host: "+e.type),e.type){case"receive-start-application":this.resetTurn(),this.startInterval(),e.payload.currentSpeaker=this.state.members[0];break;case"receive-end-turn":this.endTurn();let t=this.nextSpeaker();e.payload.nextSpeaker=t}return e}processMessage(e){switch(e.type){case"receive-start-application":this.resetTurn(),this.state.notes=`${e.payload.note}`,this.state.currentSpeaker=e.payload.currentSpeaker,this.renderComponent();break;case"receive-close-application":this.kosyApi.stopApp();break;case"receive-end-turn":this.endTurn(),this.state.currentSpeaker=e.payload.nextSpeaker,null!=this.state.currentSpeaker?this.resetTurn():(this.endInterval(),this.state.isPaused=null,this.state.ended=!0,this.state.notes=null),this.renderComponent();break;case"receive-restart-round":this.state.ended=null,this.state.currentSpeaker=null,this.state.notes=null,this.state.isPaused=!1,this.resetMembers(),this.renderComponent();break;case"receive-update-turn":this.state.isPaused=e.payload,this.renderComponent();break;case"receive-update-timer":this.state.isPaused||(this.state.timePassed+=1e3,this.renderComponent())}}processComponentMessage(e){switch(console.log("Message received as client: "+e.type),e.type){case"start-application":this.kosyApi.relayMessage({type:"receive-start-application",payload:{note:e.payload,currentSpeaker:null}});break;case"close-application":this.kosyApi.relayMessage({type:"receive-close-application"});break;case"end-turn":this.kosyApi.relayMessage({type:"receive-end-turn",payload:{endedSpeaker:this.state.currentSpeaker,nextSpeaker:null}});break;case"update-turn":this.kosyApi.relayMessage({type:"receive-update-turn",payload:e.payload});break;case"update-timer":this.kosyApi.relayMessage({type:"receive-update-timer"});break;case"restart-round":this.kosyApi.relayMessage({type:"receive-restart-round"})}}renderComponent(){!function(n,a){let r,l=document.getElementById("root");r=null!=(null==n?void 0:n.notes)?e:n.currentClient.clientUuid==n.initializer.clientUuid?n.ended?i:t:s;var o=l.cloneNode(!1);l.parentNode.replaceChild(o,l),o.appendChild(r(n,a))}({notes:this.state.notes,currentClient:this.currentClient,initializer:this.initializer,members:this.state.members,currentSpeaker:this.state.currentSpeaker,isPaused:this.state.isPaused,ended:this.state.ended,timePassed:this.state.timePassed},(e=>this.processComponentMessage(e)))}log(...e){var t,s;console.log(`${null!==(s=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==s?s:"New user"} logged: `,...e)}sortMembers(){let e=[0,2,6,5,9,7,3,1,8,4];this.state.members.sort(((t,s)=>e.indexOf(t.clientInfo.clientLocation.seatNumber)>e.indexOf(s.clientInfo.clientLocation.seatNumber)?1:-1))}addMember(e){this.state.members.push(new a(e))}removeMember(e){let t=this.state.members.find((t=>t.clientInfo.clientUuid==e));if(null!=t){let e=this.state.members.indexOf(t);this.state.members.splice(e,1)}}endTurn(){for(let e=0;e<this.state.members.length;e++)this.state.members[e].clientInfo.clientUuid==this.state.currentSpeaker.clientInfo.clientUuid&&(this.state.members[e].tookTurn=!0)}nextSpeaker(){return this.haveAllMembersTakenTurn()?null:this.state.members.find((e=>0==e.tookTurn))}haveAllMembersTakenTurn(){return null==this.state.members.find((e=>0==e.tookTurn))}resetMembers(){this.state.members.forEach((e=>e.tookTurn=!1))}resetTurn(){this.state.timePassed=0,this.state.isPaused=!1}startInterval(){console.log("Starting interval"),this.currentInterval=window.setInterval((()=>this.refreshElapsedTime()),1e3),console.log("Current interval: "+this.currentInterval)}endInterval(){this.currentInterval&&(console.log("Clearing interval"),console.log("Current interval to clear: "+this.currentInterval),window.clearInterval(this.currentInterval))}refreshElapsedTime(){this.processComponentMessage({type:"update-timer"})}}r.App=l,(new l).start()})((l=r.Integration||(r.Integration={})).Round||(l.Round={}))}(r||(r={}))})()})();