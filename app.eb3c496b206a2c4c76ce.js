(()=>{"use strict";(()=>{function e(e,t){let n=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0);null!=e.notes&&(n.querySelector("#notes").innerHTML=e.notes);let s=n.querySelector("#end-turn");s.onclick=e=>{t({type:"end-turn"})};let r=n.querySelector("#pause-turn"),i=n.querySelector("#play-turn");r.style.display=e.roundManager.isPaused?"none":"shown",i.style.display=e.roundManager.isPaused?"shown":"none",i.onclick=e=>{t({type:"update-turn",payload:!0})},r.onclick=e=>{t({type:"update-turn",payload:!1})};let a=n.querySelector("#timer");if(null!=e.roundManager.timeTurnStarted?a.innerHTML=function(e,t){let n=(new Date).getTime()-e.getTime()-t,s=Math.floor(n%36e5/6e4);var r=Math.floor(n%6e4/1e3);return(s<10?"0"+s:s)+":"+(r<10?"0"+r:r)}(e.roundManager.timeTurnStarted,e.roundManager.pausedTime):a.innerHTML="00:00",e.roundManager.isPaused&&(e.roundManager.pausedTime+=1e3),null!=e.roundManager.currentSpeaker){let t=n.querySelector("#speaker");e.roundManager.currentSpeaker.clientInfo.clientUuid==e.currentClient.clientUuid?t.innerHTML='Its <span class="highlight">your</span> turn now!':(r.style.display="none",i.style.display="none",s.style.display="none",t.innerHTML=null!=e.roundManager.getNextSpeaker()?`<span class="highlight">${e.roundManager.currentSpeaker.clientInfo.clientName}</span> is taking a turn`:`<span class="highlight">${e.roundManager.currentSpeaker.clientInfo.clientName}</span> is taking the <span class="highlight">last</span> turn`)}return null!=e.roundManager.getNextSpeaker()&&(n.querySelector("#next-speaker").innerHTML=e.roundManager.getNextSpeaker().clientInfo.clientUuid==e.currentClient.clientUuid?"You are next":`${e.roundManager.getNextSpeaker().clientInfo.clientName} is next`),n}function t(e,t){let n=document.querySelector("#setup").content.cloneNode(!0),s=n.querySelector("textarea"),r=n.querySelector("#launch-application");return document.querySelector("#viewing").hidden=!0,s.oninput=e=>{let t=s.value;null!=t&&""!=t?(r.removeAttribute("disabled"),r.classList.add("valid")):r.setAttribute("disabled","disabled")},r.onclick=e=>{let n=s.value;t({type:"start-application",payload:n})},n}function n(e,t){let n=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0);return n.querySelector("label").innerHTML=`${e.initializer.clientName} is setting up the app`,n}class s{constructor(e){this.kosyClient=window.parent,this.kosyApp=e}startApp(){return new Promise(((e,t)=>{window.addEventListener("message",(t=>{let n=t.data;switch(n.type){case"receive-initial-info":e(n.payload);break;case"client-has-joined":this.kosyApp.onClientHasJoined(n.payload);break;case"client-has-left":this.kosyApp.onClientHasLeft(n.clientUuid);break;case"get-app-state":const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",payload:t,clientUuids:n.clientUuids});break;case"set-app-state":this.kosyApp.onProvideState(n.state);break;case"receive-message":this.kosyApp.onReceiveMessage(n.payload)}})),this._sendMessageToKosy({type:"ready-and-listening"})}))}stopApp(){this._sendMessageToKosy({type:"stop-app"})}relayMessage(e){this._sendMessageToKosy({type:"relay-message",payload:e})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}}class r{constructor(e){this.clientInfo=e,this.tookTurn=!1}}class i{constructor(e,t,n,s){this.members=new Array,t&&(this.members=t),this.dispatch=e,this.currentSpeaker=this.members.find((e=>0==e.tookTurn))}startRound(){this.currentSpeaker=this.members[0],this.startTurn()}addMember(e){this.members.push(new r(e))}removeMember(e){var t,n;for(let n=0;n<this.members.length;n++)if(e==this.members[n].clientInfo.clientUuid)return void(t=this.members[n]);null!=t&&(n=this.members.indexOf(t),this.members.splice(n,1))}endTurn(){var e;clearInterval(this.currentInterval),this.timeTurnStarted=null,this.currentSpeaker.tookTurn=!0,null!=this.currentSpeaker&&(e=this.members.indexOf(this.currentSpeaker),this.members.splice(e,1,this.currentSpeaker)),this.haveAllMembersTakenTurn()?this.currentSpeaker=null:(this.currentSpeaker=this.members.find((e=>0==e.tookTurn)),this.startTurn())}getNextSpeaker(){return this.members.find((e=>0==e.tookTurn&&e!=this.currentSpeaker))}haveAllMembersTakenTurn(){return null==this.members.find((e=>0==e.tookTurn))}startTurn(){this.timeTurnStarted=new Date,this.pausedTime=0,this.isPaused=!1,this.currentInterval=window.setInterval((()=>this.refreshElapsedTime()),1e3)}refreshElapsedTime(){this.dispatch({type:"update-timer"})}}var a;!function(r){var a;(function(r){class a{constructor(){this.state={notes:null,roundManager:null},this.kosyApi=new s({onClientHasJoined:e=>this.onClientHasJoined(e),onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessage:e=>this.processMessage(e),onRequestState:()=>this.getState(),onProvideState:e=>this.setState(e)})}start(){var e,t,n,s,r;return t=this,n=void 0,r=function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,null==this.state.roundManager?(this.state.roundManager=new i((e=>this.processComponentMessage(e))),this.state.roundManager.addMember(this.currentClient)):this.state.roundManager=new i((e=>this.processComponentMessage(e)),this.state.roundManager.members),this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))},new((s=void 0)||(s=Promise))((function(e,i){function a(e){try{l(r.next(e))}catch(e){i(e)}}function o(e){try{l(r.throw(e))}catch(e){i(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(a,o)}l((r=r.apply(t,n||[])).next())}))}setState(e){this.state=e,this.renderComponent()}getState(){return this.state}onClientHasJoined(e){null!=this.currentClient&&null!=this.initializer&&this.state.roundManager.addMember(e)}onClientHasLeft(e){this.currentClient.clientUuid===this.initializer.clientUuid&&this.state.roundManager.removeMember(e),e!==this.initializer.clientUuid||this.state.notes||this.kosyApi.stopApp()}processMessage(e){switch(e.type){case"receive-start-application":this.state.notes=`${e.payload}`,this.currentClient.clientUuid==this.initializer.clientUuid&&this.state.roundManager.startRound(),this.renderComponent();break;case"receive-end-turn":this.state.roundManager.endTurn(),this.state.roundManager.haveAllMembersTakenTurn()?this.kosyApi.stopApp():this.renderComponent();break;case"receive-update-turn":this.state.roundManager.isPaused=e.payload,this.renderComponent();break;case"receive-update-timer":this.renderComponent()}}processComponentMessage(e){switch(e.type){case"start-application":this.kosyApi.relayMessage({type:"receive-start-application",payload:e.payload});break;case"end-turn":this.kosyApi.relayMessage({type:"receive-end-turn"});break;case"update-turn":this.kosyApi.relayMessage({type:"receive-update-turn",payload:e.payload});break;case"update-timer":this.kosyApi.relayMessage({type:"receive-update-timer"})}}renderComponent(){!function(s,r){let i,a=document.getElementById("root");i=(null==s?void 0:s.notes)?e:s.currentClient.clientUuid==s.initializer.clientUuid?t:n;var o=a.cloneNode(!1);a.parentNode.replaceChild(o,a),o.appendChild(i(s,r))}({notes:this.state.notes,currentClient:this.currentClient,initializer:this.initializer,roundManager:this.state.roundManager},(e=>this.processComponentMessage(e)))}log(...e){var t,n;console.log(`${null!==(n=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==n?n:"New user"} logged: `,...e)}}r.App=a,(new a).start()})((a=r.Integration||(r.Integration={})).Round||(a.Round={}))}(a||(a={}))})()})();