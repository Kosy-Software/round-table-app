(()=>{"use strict";(()=>{function e(e,t){let s=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0);e.notes?s.querySelector("#notes").innerHTML=e.notes:s.querySelector("#notes-box").style.display="none";let n=s.querySelector("#end-turn");n.onclick=e=>{t({type:"end-turn"})};let i=s.querySelector("#update-turn"),a=s.querySelector("#play");s.querySelector("#pause").style.display=e.isPaused?"none":"shown",a.style.display=e.isPaused?"shown":"none",i.onclick=s=>{t({type:"update-turn",payload:!e.isPaused})};let r=s.querySelector("#timer");null!=e.timePassed&&(r.innerHTML=function(e){let t=Math.floor(e%36e5/6e4);var s=Math.floor(e%6e4/1e3);return(t<10?"0"+t:t)+":"+(s<10?"0"+s:s)}(e.timePassed));let l=e.members.find((t=>0==t.tookTurn&&t.clientInfo.clientUuid!=e.currentSpeaker.clientInfo.clientUuid));if(null!=e.currentSpeaker){let t=s.querySelector("#speaker");e.currentSpeaker.clientInfo.clientUuid==e.currentClient.clientUuid?t.innerHTML='Its <span class="highlight">your</span> turn now!':(i.style.display="none",n.style.display="none",t.innerHTML=null!=l?`<span class="highlight">${e.currentSpeaker.clientInfo.clientName}</span> is taking a turn`:`<span class="highlight">${e.currentSpeaker.clientInfo.clientName}</span> is taking the <span class="highlight">last</span> turn`)}return null!=l&&(s.querySelector("#next-speaker").innerHTML=l.clientInfo.clientUuid==e.currentClient.clientUuid?"You are next":`${l.clientInfo.clientName} is next`),s}function t(e,t){let s=document.querySelector("#setup").content.cloneNode(!0),n=s.querySelector("textarea"),i=s.querySelector("#launch-application");return document.querySelector("#viewing").hidden=!0,i.onclick=e=>{var s;t({type:"start-application",payload:null!==(s=n.value)&&void 0!==s?s:""})},s}function s(e,t){let s=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0);return s.querySelector("label").innerHTML=`${e.initializer.clientName} is setting up the app`,s}function n(e,t){let s=document.querySelector("#ended").content.cloneNode(!0),n=s.querySelector("#restart-application"),i=s.querySelector("#close-application");return document.querySelector("#viewing").hidden=!0,e.currentClient.clientUuid!=e.initializer.clientUuid&&(n.style.display="none",i.style.display="none"),n.onclick=e=>{t({type:"restart-round"})},i.onclick=e=>{t({type:"close-application"})},s}class i{constructor(e){this.kosyClient=window.parent,this.latestMessageNumber=0,this.kosyApp=e}startApp(){return this.initialInfoPromise=new Promise(((e,t)=>{window.addEventListener("message",(t=>{let s=t.data;switch(s.type){case"receive-initial-info":e(s.payload),this.latestMessageNumber=s.latestMessageNumber;break;case"client-has-joined":this.kosyApp.onClientHasJoined(s.clientInfo);break;case"client-has-left":this.kosyApp.onClientHasLeft(s.clientUuid);break;case"get-app-state":const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",state:t,clientUuids:s.clientUuids,latestMessageNumber:this.latestMessageNumber});break;case"set-app-state":this.kosyApp.onProvideState(s.state),this.latestMessageNumber=s.latestMessageNumber;break;case"receive-message-as-host":this._handleReceiveMessageAsHost(s);break;case"receive-message-as-client":this._handleReceiveMessageAsClient(s)}})),this._sendMessageToKosy({type:"ready-and-listening"})})),this.initialInfoPromise}stopApp(){this._sendMessageToKosy({type:"stop-app"})}relayMessage(e){this._sendMessageToKosy({type:"relay-message-to-host",message:e})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}_handleReceiveMessageAsClientRecursive(e,t,s){this.latestMessageNumber===e.messageNumber-(t.currentClientUuid===e.sentByClientUuid?0:1)?(this.kosyApp.onReceiveMessageAsClient(e.message),this.latestMessageNumber=e.messageNumber):s<50&&this.latestMessageNumber<e.messageNumber&&setTimeout((()=>this._handleReceiveMessageAsClientRecursive(e,t,s+1)),100)}_handleReceiveMessageAsClient(e){this.initialInfoPromise.then((t=>{this._handleReceiveMessageAsClientRecursive(e,t,0)}))}_handleReceiveMessageAsHost(e){this.initialInfoPromise.then((t=>{const s=this.kosyApp.onReceiveMessageAsHost(e.message);s&&this._sendMessageToKosy({type:"relay-message-to-clients",sentByClientUuid:t.currentClientUuid,message:s,messageNumber:++this.latestMessageNumber})}))}}class a{constructor(e){this.clientInfo=e,this.tookTurn=!1}}var r;!function(r){var l;(function(r){class l{constructor(){this.state={timePassed:0},this.kosyApi=new i({onClientHasJoined:e=>this.onClientHasJoined(e),onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessageAsClient:e=>this.processMessage(e),onReceiveMessageAsHost:e=>this.processMessageAsHost(e),onRequestState:()=>this.getState(),onProvideState:e=>this.setState(e)})}start(){var e,t,s,n,i;return t=this,s=void 0,i=function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,console.log(this.state),null==this.state.members&&(this.state.members=new Array,t.clients&&Object.keys(t.clients).length>0?Object.keys(t.clients).forEach((e=>this.addMember(t.clients[e]))):this.currentClient.clientUuid==this.initializer.clientUuid&&this.addMember(this.currentClient)),this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))},new((n=void 0)||(n=Promise))((function(e,a){function r(e){try{o(i.next(e))}catch(e){a(e)}}function l(e){try{o(i.throw(e))}catch(e){a(e)}}function o(t){var s;t.done?e(t.value):(s=t.value,s instanceof n?s:new n((function(e){e(s)}))).then(r,l)}o((i=i.apply(t,s||[])).next())}))}setState(e){this.state=e,this.renderComponent()}getState(){return this.state}onClientHasJoined(e){null!=this.currentClient&&null!=this.initializer&&this.addMember(e)}onClientHasLeft(e){this.removeMember(e)}processMessageAsHost(e){switch(e.type){case"receive-start-application":this.resetTurn(),this.startInterval(),e.payload.currentSpeaker=this.state.members[0];break;case"receive-end-turn":this.endTurn();let t=this.nextSpeaker();e.payload.nextSpeaker=t}return e}processMessage(e){switch(e.type){case"receive-start-application":this.resetTurn(),this.state.notes=`${e.payload.note}`,this.state.currentSpeaker=e.payload.currentSpeaker,this.renderComponent();break;case"receive-close-application":this.kosyApi.stopApp();break;case"receive-end-turn":this.endTurn(),this.state.currentSpeaker=e.payload.nextSpeaker,null!=this.state.currentSpeaker?this.resetTurn():(this.endInterval(),this.state.isPaused=null,this.state.ended=!0,this.state.notes=null),this.renderComponent();break;case"receive-restart-round":this.state.ended=null,this.state.currentSpeaker=null,this.state.notes=null,this.state.isPaused=!1,this.resetMembers(),this.renderComponent();break;case"receive-update-turn":this.state.isPaused=e.payload,this.renderComponent();break;case"receive-update-timer":this.state.isPaused||(this.state.timePassed+=1e3,this.renderComponent())}}processComponentMessage(e){switch(e.type){case"start-application":this.kosyApi.relayMessage({type:"receive-start-application",payload:{note:e.payload,currentSpeaker:null}});break;case"close-application":this.kosyApi.relayMessage({type:"receive-close-application"});break;case"end-turn":this.kosyApi.relayMessage({type:"receive-end-turn",payload:{endedSpeaker:this.state.currentSpeaker,nextSpeaker:null}});break;case"update-turn":this.kosyApi.relayMessage({type:"receive-update-turn",payload:e.payload});break;case"update-timer":this.kosyApi.relayMessage({type:"receive-update-timer"});break;case"restart-round":this.kosyApi.relayMessage({type:"receive-restart-round"})}}renderComponent(){!function(i,a){let r,l=document.getElementById("root");r=null!=(null==i?void 0:i.notes)?e:i.currentClient.clientUuid==i.initializer.clientUuid?i.ended?n:t:s;var o=l.cloneNode(!1);l.parentNode.replaceChild(o,l),o.appendChild(r(i,a))}({notes:this.state.notes,currentClient:this.currentClient,initializer:this.initializer,members:this.state.members,currentSpeaker:this.state.currentSpeaker,isPaused:this.state.isPaused,ended:this.state.ended,timePassed:this.state.timePassed},(e=>this.processComponentMessage(e)))}log(...e){var t,s;console.log(`${null!==(s=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==s?s:"New user"} logged: `,...e)}addMember(e){this.state.members.push(new a(e))}removeMember(e){let t=this.state.members.find((t=>t.clientInfo.clientUuid==e));if(null!=t){let e=this.state.members.indexOf(t);this.state.members.splice(e,1)}}endTurn(){for(let e=0;e<this.state.members.length;e++)this.state.members[e].clientInfo.clientUuid==this.state.currentSpeaker.clientInfo.clientUuid&&(this.state.members[e].tookTurn=!0)}nextSpeaker(){return this.haveAllMembersTakenTurn()?null:this.state.members.find((e=>0==e.tookTurn))}haveAllMembersTakenTurn(){return null==this.state.members.find((e=>0==e.tookTurn))}resetMembers(){this.state.members.forEach((e=>e.tookTurn=!1))}resetTurn(){this.state.timePassed=0,this.state.isPaused=!1}startInterval(){console.log("Starting interval"),this.currentInterval=window.setInterval((()=>this.refreshElapsedTime()),1e3),console.log("Current interval: "+this.currentInterval)}endInterval(){this.currentInterval&&(console.log("Clearing interval"),console.log("Current interval to clear: "+this.currentInterval),window.clearInterval(this.currentInterval))}refreshElapsedTime(){this.processComponentMessage({type:"update-timer"})}}r.App=l,(new l).start()})((l=r.Integration||(r.Integration={})).Round||(l.Round={}))}(r||(r={}))})()})();